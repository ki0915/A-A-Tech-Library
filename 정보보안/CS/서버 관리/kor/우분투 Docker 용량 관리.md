![](https://velog.velcdn.com/images/tkops365/post/f03cd953-edc3-4ae4-8b00-60576cf465e8/image.png)


회사에서 도커 사용 중에 어려운 오류를 마주쳤다. 우분투에 할당된 4테라 용량이 부족하여 기존 서비스가 먹통이 된 것이다. 처음에는 용량을 많이 차지하는 파일이나 로그를 삭제함으로 대응하면 될 줄 알았지만, 그건 근본적인 문제가 아니었다. 

이 문제에 수 많은 시간을 소비했기에 나와 같은 개발자들을 위해 문제 해결 방법을 공유하기로 했다. 특히 나처럼 도커 서버를 개발하고 관리하는 이들에게 도움이 되었으면 좋겠다. 

# 1. 발생하는 오류


![](https://velog.velcdn.com/images/tkops365/post/72458452-fa5d-43e7-8f4b-c01625fdce7d/image.png)

(예시 사진)

도커를 사용하다보면 디스크의 사용량이 갑자기 늘어나있는 광경을 볼 수 있다. 그러면 도커 컨테이너에 들어가서 db의 용량이나 컨테이너의 파일들을 뒤져보지만, 원인을 알 수 없었다. 

<span style="color: red"> 왜일까? </span>

그 이유는 간단한다.  


**컨테이너 끼리 디스크 볼륨을 공유하고 있고 그 디스크 볼륨에 오랜 시간 서버의 쓰레기 데이터 값이 쌓이기 때문이다. **


주로 로직을 담당하는 서버 컨테이너에 쌓이지만, 오랜 시간 방치하면 데이터 베이스 같은 다른 부속 컨테이너들에도 쌓이게 된다.

* 필자는 mariaDB, nginx, Grafana, phpadmin, 등에도 어머어마한 쓰레기 값이 쌓여있었다.

원인을 간단하게 설명하자면, 삭제되거나 사용하지 않는 이미지나 컨테이너의 볼륨이 쌓여서 저런 사태를 만들어낸 것이다. 

<span style="color: red"> 이럴 때 조치는 어떻게 해야 하는가? </span>

이럴 때를 대비하여 docker 에서는 명령어 들을  준비해두었다. 


바로 **docker system prune**이다.


먼저 방법을 설명하겠다. 

```
docker ps -a 
```
먼저 위 명령어로 현재 실행되고 있는 컨테이너들을 확인하고 용량이 큰 컨테이너들을 고른다.

(사실 서버의 용량이 모자란 정도라면 모든 컨테이너가 문제가 있는 상태이다.)

그리고 나서 
```
docker stop <container_id>

---------------------------------

모든 컨테이너 정지는 

docker stop all
```
위 명령어를 통해 컨테이너를 정지시킨다.

그 다음 아래의 명령어로 컨테이너를 삭제한다. 

```
docker rm <container_id>
----------------------------------
모든 컨테이너 삭제는 

docker rm $(docker ps -a -q)
```

그 다음에 모든 이미지나 이미지 등을 삭제하는 것은 선택 사항이기도 하다. 

이 부분은 명령어만 언급하겠다. (보통은 안해도 괜찮다. 용량에 변화가 없을 때에 실행. -> 하지만 쓰지 않는 이미지들만 지울 수 있게 조심하자.)

존재하는 모든 이미지 확인:

```
docker images
```

특정 이미지 삭제:

```
docker rmi <image_id>
```
모든 이미지를 삭제하려면 다음 명령어를 사용할 수 있다:

```
docker rmi $(docker images -q)

```

그 다음에는 이제 docker에서 사용되지 않는 데이터들을 삭제해줄 시간이다.

사용하지 않는 볼륨 삭제:

```
docker volume prune
```

사용하지 않는 컨테이너, 이미지, 볼륨 및 네트워크를 모두 삭제:

```
docker system prune -a
```

위 가정을 마치기 컨테이너들을 다시 만들고 실행하면 획기적인 용량 확보가 가능할 것이다.

필자는 3테라를 확보했다.

보통은 위 볼륨 삭제 과정에서 docker volume prune 이 명령어만 사용하고 마쳐도 되지만, 필자는 첫 번째 시도 때 그렇게 했다고 3달도 되지 않아 또 용량 문제에 시달렸다.

그렇기에 쓰지 않는 이미지와 볼륨, 컨테이너, 네트워크 등을 삭제 하는 docker system prune -a

를 사용했다.

물론 무조건 저 명령어를 쓰라는 건 아니다. 무슨 문제가 생길 지도 모르기 때문이다.

<span style="color: yellow"> 이 방법을 사용하여 우분투에서 도커를 사용할 때에 용량 문제에 시달리지 않길 바란다. 볼륨 관리가 중요하다는 것을 또 한번 배우게 되어 뜻 깊은 사건이었다.</span>
